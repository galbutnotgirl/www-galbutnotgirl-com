/*!
 * contentstack-express
 * copyright (c) Built.io Contentstack
 * MIT Licensed
 */

'use strict';

/*!
 * Module dependencies
 */
var path = require('path'),
	fs = require('fs');

/**
 * template manager
 */
module.exports = function (utils) {
	var config = utils.config;

	return function matrix(req, res, next) {
		try {
			if (req._contentstack.response_type != "json" && req._contentstack.content_type) {
				var template;
				if (req._contentstack.content_type) {
					var content_type = req._contentstack.content_type,
						templatesDir = 'pages',
						ext = config.get('view.extension') || 'html',
						_templates = path.join(config.get('path.templates'), templatesDir, content_type);

					var lang = req._contentstack.lang.code;
					// for language based templates
					if (lang && fs.existsSync(path.join(_templates, lang, 'index.' + ext))) {
						template = path.join(_templates, lang, 'index.' + ext);
					// for templates with content_type/index.html or content_type.html
					} else if (fs.existsSync(path.join(_templates, 'index.' + ext))) {
						template = path.join(_templates, 'index.' + ext);
					} else if (fs.existsSync(path.join(_templates + '.' + ext))) {
						template = _templates + '.' + ext;
					} else if (fs.existsSync(path.join(_templates, 'single.' + ext))) {
						template = path.join(_templates, "single");
					}
				}
				req._contentstack.template = template;
			}
			next();
		} catch (e) {
			next(e);
		}
	};
};
