/*!
 * contentstack-express
 * copyright (c) Built.io Contentstack
 * MIT Licensed
 */

'use strict';

/**
 * search for the requested route in the system.
 */
module.exports = function (utils) {
	var db = utils.db;
	return function smug(req, res, next) {
		db
			.ContentType('_routes')
			.language(req._contentstack.lang.code)
			.Query()
			.or('entry.url', req._contentstack.lang.url)
			.or('entry.url', req._contentstack.parsedUrl)
			.findOne()
			.then(function (data) {
				if (data && typeof data === "object") {
					db
						.ContentType(data.content_type.uid)
						.language(req._contentstack.lang.code)
						.Query()
						.findOne(data.entry.uid)
						.then(function (entry) {
							req._contentstack.content_type = data.content_type.uid;
							req._contentstack.entry = entry;
							next();
						}, function (err) {
							next(err);
						});
				} else {
					next();
				}
			});
	};
};
